#!/usr/bin/ruby
# RightScale API examples with basic xml parsing
# 
# MORE INFO: 
# rest_client ruby gem  http://rest-client.heroku.com/rdoc/
# crack ruby gem http://github.com/jnunemaker/crack/tree/master 
# http://github.com/jnunemaker/crack/tree/master

require 'rubygems'   # not required if ruby >= 1.9
require 'rest_client'
require 'crack'


#####
## Overview
#####

# Log all the interactions to/from RightScale for debugging

RestClient.log = 'rest.log'

# Create a new object to the RightScale API.
# This object will stay open and only needs to be created once.
# This base URI will be appended to with our specific REST calls to the API

rsAPI = RestClient::Resource.new("https://my.rightscale.com/api/acct/#{account}",username, password)

## Change a resource: pass hash of parameters
## 
## Before you can change a resource you must first determine the 
## REST statement needed for this.  In the following example
## we will change the name/nickname of a server in a deployment
##
## Step 1: find the server # through the RightScale dashboard
##	     by hovering over the server link & noting the server #.
## Step 2: Determine the REST call needed & what parameters are 
## 	     needed if any.
## Step 3: Pass the parameters to the proper rest_client object

## REST: PUT https://my.rightscale.com/api/acct/xxx/servers/yyy/
##	 Passes parameters as a hash.
##	 Adds custom header required by RightScale :x_api_version = '1.0'
##	 See the documentation for responses & parameters

server = '680079'
#params = { "server[nickname]" => "RC: NewAPITEST" }
#data = rsAPI["servers/#{server}"].put params, :x_api_version => '1.0'


## Retrieve information on one server
## Since authenication and the base URI have been created
## We can use the existing object and supply the specific
## Resource we want to manipulate.

#data = rsAPI["servers/#{server}"].get :x_api_version => '1.0'

## Get information all your servers
## REST: GET https://my.rightscale.com/api/acct/xxx/servers

#data = rsAPI["servers"].get :x_api_version => '1.0'

## Start a server using post
## Passes an empty parameter hash 
#params = {}
#data = rsAPI["servers/#{server}/start"].post params, :x_api_version => '1.0'

## Run script against a server
## Determine the script # via the RightScale dashboard
## URL: POST /api/acct/1/servers/000/run_script

#scriptnumber = 45374
#params = { "right_script" => "#{scriptnumber}" }
#data = rsAPI["servers/#{server}/run_script"].post params, :x_api_version => '1.0'

puts data.inspect

#test = Crack::XML.parse(data)
#puts data.inspect
#test['servers'].each { |servers| puts servers['nickname'] }


#deployments = RestClient::Resource.new('https://my.rightscale.com/api/acct/7954/deployments?api_version=1.0',username,password)
#resp = deployments.get
#data = Crack::XML.parse(resp)

#data['deployments'].each { | deployment| puts deployment['nickname'] }

